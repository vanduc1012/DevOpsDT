name: Deploy DevOpsDT to EC2

# Khi nào workflow chạy
on:
  push:
    branches:
      - main                # tự động chạy khi push lên main
  workflow_dispatch:        # cho phép chạy thủ công từ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code từ repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Deploy code lên EC2 bằng SSH
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}       # Elastic IP EC2
          username: ${{ secrets.EC2_USER }}   # user trên EC2 (ubuntu)
          key: ${{ secrets.EC2_KEY }}         # private key SSH
          port: 22
          script: |
            echo "Starting deployment on EC2..."
            cd /home/ubuntu/DevOpsDT           # thư mục project trên EC2
            git reset --hard                   # đảm bảo code sạch trước khi pull
            git pull origin main               # lấy code mới
            npm install                        # cài dependencies
            pm2 restart all                     # restart tất cả app PM2
            echo "Deployment finished successfully!"
